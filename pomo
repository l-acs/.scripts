#!/bin/bash

shopt -s extglob

pomodoro (){
    date_readable="$(echo "${1}" | sed 's/s/ seconds/' | sed 's/m/ minutes/' | sed 's/h/ hours/')"
    name=Timer && [ "${1}"  = "25m" ] && name=Pomodoro && killall dunst #silence notifications
    label="" && [ "${*:2}" != "$name done!" ] && label=" - ${*:2}"
    echo "$name set from $(date +%-I:%M\ %p) until $(date -d "$date_readable" +%-I:%M\ %p)$label"
    
    
    sleep "${1}" &&
	{ pgrep -xU "$UID" dunst || dunst & disown ; } &>/dev/null &&
	notify-send "${*:2}" >/dev/null &&
	mpv --force-window --loop-playlist=inf --really-quiet ~/.scripts/input/ringtone.webm &&
	dunstctl close-all & disown

}


case "$#" in
    0)
	pomodoro 25m "Pomodoro done!" ;;

    1)
	case "$*" in
	    +([0-9]))
		pomodoro "$*m" "Timer done!" ;;

	    +([0-9])[h,s,m])
		pomodoro "$*" "Timer done!" ;;
			    

	    "cancel")
	 	killall sleep ;;
	

	    "stop")
		pkill -f 'mpv.*ringtone' 1;;
	    

	    *)
		pomodoro 25m "$*" ;;

	 esac
	
	;;


    *)
	case "$1" in
	    +([0-9]))
		pomodoro "$1m" "${*:2}" ;;

	    +([0-9])[h,s,m])
		pomodoro "$1"  "${*:2}" ;;

	    *)
		pomodoro 25m "$*" 2>/dev/null || (echo "Timer length must precede message." && exit 1) ;;

	 esac

	;;
esac
